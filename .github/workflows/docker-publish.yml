name: Docker Publish

on:
  push:
    branches: [ main, master ]
    tags:
      - '*'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build .

  deploy:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract and validate tag
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          if [[ ! $TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Tag '$TAG' is not a valid semantic version (expected format: X.Y.Z)"
            exit 1
          fi
          echo "TAG=$TAG" >> $GITHUB_OUTPUT

      - name: Log in to Google Artifact Registry
        run: echo ${{ secrets.GAR_API_KEY }} | docker login -u _json_key --password-stdin europe-west3-docker.pkg.dev

      - name: Build Docker image
        run: docker build -t europe-west3-docker.pkg.dev/deskbird-project/deskbird/audit-web:${{ steps.tag.outputs.TAG }} .

      - name: Push Docker image
        run: docker push europe-west3-docker.pkg.dev/deskbird-project/deskbird/audit-web:${{ steps.tag.outputs.TAG }}
